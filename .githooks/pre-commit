#!/bin/bash

# Git pre-commit hook that runs make commands before allowing commits
# This ensures generated code is up-to-date before committing

# Ensure Go binaries are in PATH
# Add common Go binary paths to PATH
export PATH=$PATH:$HOME/go/bin:/usr/local/go/bin

# Also try to source the user's profile to get their PATH settings
if [ -f ~/.bash_profile ]; then
    source ~/.bash_profile 2>/dev/null
elif [ -f ~/.zshrc ]; then
    source ~/.zshrc 2>/dev/null
elif [ -f ~/.profile ]; then
    source ~/.profile 2>/dev/null
fi

echo "ğŸš€ Running pre-commit checks..."

# Run make commands to ensure generated code is current
echo "ğŸ“¦ Generating protobuf code..."
if ! make gen_geovision; then
    echo "âŒ Failed to generate geovision protobuf code"
    exit 1
fi

echo "ğŸ“¦ Generating OpenAPI documentation..."
if ! make gen_geovision_openapi; then
    echo "âŒ Failed to generate OpenAPI documentation"
    exit 1
fi

# Check if any generated files were modified and automatically add them to the commit
if git diff --name-only --cached | grep -E "^(gen/)" > /dev/null; then
    echo "âš ï¸  Generated files were modified during pre-commit"
    echo "   Automatically adding generated files to the current commit:"
    
    # Get the list of modified generated files
    generated_files=$(git diff --name-only --cached | grep -E "^(gen/)")
    echo "$generated_files"
    
    # Add the generated files to the current commit
    echo "$generated_files" | xargs git add
    
    echo "âœ… Generated files have been added to the current commit"
fi

echo "âœ… Pre-commit checks passed!"
exit 0